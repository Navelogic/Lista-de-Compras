<!DOCTYPE html>
<html lang="pt-BR" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Lista de Compras</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/9d986ddfce.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; }
        .sortable-chosen { cursor: grabbing !important; }
        .drag-handle { cursor: grab; }

        .currency-display { 
            font-feature-settings: 'tnum' 1;
            letter-spacing: -0.025em;
        }
        
        .section-card { transition: all 0.2s ease; }
        .section-card:hover { transform: translateY(-1px); box-shadow: 0 8px 25px -8px rgba(0,0,0,0.1); }
        
        .section-badge { 
            background: rgba(var(--p), 0.1); 
            color: rgb(var(--p)); 
            border: 1px solid rgba(var(--p), 0.2);
        }
        .subsection-badge { 
            background: rgba(var(--s), 0.1); 
            color: rgb(var(--s)); 
            border: 1px solid rgba(var(--s), 0.2);
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen transition-colors duration-500">
    <header class="sticky top-0 z-30 bg-base-100 shadow-md">
        <div class="navbar px-4">
            <div class="flex-1">
                <h1 class="text-xl font-bold text-primary truncate">Minha Lista de Compras</h1>
            </div>
            <div class="flex-none gap-2">
                <button class="btn btn-sm btn-ghost btn-circle" data-action="open-settings-modal" aria-label="Abrir configurações">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="p-4 space-y-4 pb-24">
        <div class="collapse collapse-arrow bg-base-100 shadow-md">
            <input type="checkbox" id="adder-toggle" checked />
            <div class="collapse-title text-lg font-medium">
                Resumo e Adição Rápida
            </div>
            <div class="collapse-content space-y-4">
                <div class="stats shadow w-full stats-vertical lg:stats-horizontal">
                    <div class="stat">
                        <div class="stat-title">Total</div>
                        <div id="totalPrice" class="stat-value text-primary currency-display">R$ 0,00</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Itens na Lista</div>
                        <div id="itemCount" class="stat-value text-secondary">0</div>
                    </div>
                </div>
                <div class="card bg-base-200">
                    <div class="card-body p-4">
                        <form id="addItemForm" class="space-y-3">
                            <input type="text" id="itemName" placeholder="Nome do item" class="input input-bordered w-full" required>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div class="flex gap-2">
                                    <input type="number" id="itemQuantity" value="1" min="0.01" step="0.01" class="input input-bordered flex-1" placeholder="Qtd" required>
                                    <div id="itemUnitDropdown" class="dropdown">
                                        <button type="button" tabindex="0" class="btn btn-bordered min-w-fit">Un <i class="fa-solid fa-chevron-down text-xs"></i></button>
                                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-24">
                                            <li><a data-value="un">Un</a></li>
                                            <li><a data-value="kg">Kg</a></li>
                                            <li><a data-value="g">g</a></li>
                                            <li><a data-value="l">L</a></li>
                                            <li><a data-value="ml">mL</a></li>
                                        </ul>
                                    </div>
                                    <input type="hidden" id="itemUnit" value="un">
                                </div>
                                <div class="flex gap-2">
                                    <div id="itemSectionDropdown" class="dropdown w-full">
                                        <button type="button" tabindex="0" class="btn btn-bordered w-full justify-start font-normal">
                                            <span class="truncate">Selecione</span> <i class="fa-solid fa-chevron-down text-xs ml-auto"></i>
                                        </button>
                                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto">
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-square" data-action="open-section-modal-from-adder" aria-label="Adicionar nova seção"><i class="fa-solid fa-plus"></i></button>
                                    <input type="hidden" id="itemSection" required>
                                </div>
                                <div class="flex gap-2">
                                    <div id="itemSubsectionDropdown" class="dropdown w-full">
                                        <button type="button" tabindex="0" class="btn btn-bordered w-full justify-start font-normal" disabled>
                                            <span class="truncate">Sem subseção</span> <i class="fa-solid fa-chevron-down text-xs ml-auto"></i>
                                        </button>
                                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto">
                                        </ul>
                                    </div>
                                    <input type="hidden" id="itemSubsection">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-full gap-2">
                                <i class="fa-solid fa-plus"></i> Adicionar Item
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="shoppingListContainer" class="space-y-4"></div>
    </main>
    
    <footer class="fixed bottom-0 left-0 right-0 z-30 bg-base-100 border-t border-base-300 shadow-inner">
        <div class="flex justify-between items-center w-full px-4 py-2 max-w-4xl mx-auto">
            <div class="text-left">
                <div class="text-xs text-base-content/60">Total</div>
                <div id="footerTotalPrice" class="text-xl sm:text-2xl font-bold text-primary currency-display">R$ 0,00</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-base-content/60">Itens</div>
                <div id="footerItemCount" class="text-base sm:text-lg font-semibold">0</div>
            </div>
        </div>
    </footer>

    <dialog id="edit_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Editar Item</h3>
            <form id="editItemForm" method="dialog" class="space-y-3">
                <input type="hidden" id="editItemId">
                <div class="form-control">
                    <label class="label"><span class="label-text">Nome do Item</span></label>
                    <input type="text" id="editItemName" class="input input-bordered w-full" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Quantidade e Unidade</span></label>
                         <div class="flex gap-2">
                            <input type="number" id="editItemQuantity" min="0.01" step="0.01" class="input input-bordered flex-1" required>
                            <div id="editItemUnitDropdown" class="dropdown">
                                <button type="button" tabindex="0" class="btn btn-bordered min-w-fit">Un <i class="fa-solid fa-chevron-down text-xs"></i></button>
                                <ul tabindex="0" class="dropdown-content z-[2] menu p-2 shadow bg-base-100 rounded-box w-24">
                                     <li><a data-value="un">Un</a></li><li><a data-value="kg">Kg</a></li><li><a data-value="g">g</a></li><li><a data-value="l">L</a></li><li><a data-value="ml">mL</a></li>
                                </ul>
                            </div>
                            <input type="hidden" id="editItemUnit" value="un">
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Preço (opcional)</span></label>
                        <input type="number" id="editItemPrice" step="0.01" min="0" class="input input-bordered w-full" placeholder="R$ 0,00">
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                     <div class="form-control">
                        <label class="label"><span class="label-text">Seção</span></label>
                        <div id="editItemSectionDropdown" class="dropdown w-full">
                           <button type="button" tabindex="0" class="btn btn-bordered w-full justify-start font-normal"><span class="truncate">Selecione</span> <i class="fa-solid fa-chevron-down text-xs ml-auto"></i></button>
                           <ul tabindex="0" class="dropdown-content z-[2] menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto"></ul>
                        </div>
                        <input type="hidden" id="editItemSection" required>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Subseção</span></label>
                         <div id="editItemSubsectionDropdown" class="dropdown w-full">
                           <button type="button" tabindex="0" class="btn btn-bordered w-full justify-start font-normal"><span class="truncate">Sem subseção</span> <i class="fa-solid fa-chevron-down text-xs ml-auto"></i></button>
                           <ul tabindex="0" class="dropdown-content z-[2] menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto"></ul>
                        </div>
                        <input type="hidden" id="editItemSubsection">
                    </div>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn" onclick="edit_modal.close()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>

    <dialog id="section_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4" id="sectionModalTitle">Adicionar Seção/Subseção</h3>
            <form id="sectionForm" method="dialog" class="space-y-4">
                <input type="hidden" id="sectionId">
                
                <div class="form-control">
                    <label class="label"><span class="label-text">Onde você quer criar?</span></label>
                    <div id="sectionParentDropdown" class="dropdown w-full">
                       <button type="button" tabindex="0" class="btn btn-bordered w-full justify-start font-normal">
                           <span class="truncate">Nenhuma (Será uma seção principal)</span> 
                           <i class="fa-solid fa-chevron-down text-xs ml-auto"></i>
                       </button>
                       <ul tabindex="0" class="dropdown-content z-[2] menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto"></ul>
                    </div>
                    <input type="hidden" id="sectionParent">
                </div>
    
                <div id="sectionTypeFeedback" class="p-3 rounded-lg bg-base-200 text-sm text-base-content/80 transition-all duration-300 ease-in-out">
                </div>
    
                <div class="form-control">
                    <label class="label"><span class="label-text" id="sectionNameLabel">Nome</span></label>
                    <input type="text" id="sectionName" class="input input-bordered w-full" required>
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Ícone (emoji)</span></label>
                    <input type="text" id="sectionIcon" class="input input-bordered w-full" placeholder="🛒" maxlength="11">
                </div>
                
                <div class="modal-action">
                    <button type="button" class="btn" onclick="section_modal.close()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    
    <dialog id="settings_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurações</h3>
            <div class="py-4 space-y-4">
                <div>
                    <h4 class="font-semibold mb-2">Tema</h4>
                    <div id="theme-selector-container" class="max-h-60 overflow-y-auto rounded-lg bg-base-200 p-2"></div>
                </div>

                <div class="divider"></div>

                <div>
                    <h4 class="font-semibold mb-2">Gerenciar Seções</h4>
                    <div id="section-manager-container" class="max-h-60 overflow-y-auto rounded-lg bg-base-200 p-2 space-y-2"></div>
                    <button class="btn btn-sm btn-outline mt-3 w-full" data-action="open-section-modal">
                        <i class="fa-solid fa-plus"></i> Adicionar Nova Seção
                    </button>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    
    <dialog id="confirm_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="confirmModalTitle">Confirmar Ação</h3>
            <p class="py-4" id="confirmModalMessage">Você tem certeza?</p>
            <div class="modal-action">
                <button class="btn" id="confirmModalCancel">Cancelar</button>
                <button class="btn btn-error" id="confirmModalConfirm">Confirmar</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>

    <dialog id="prompt_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="promptModalTitle">Entrada de Dados</h3>
            <p class="py-2" id="promptModalMessage">Digite um valor:</p>
            <form id="promptForm" method="dialog">
                <input id="promptModalInput" class="input input-bordered w-full">
                <div class="modal-action">
                    <button type="button" class="btn" id="promptModalCancel">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="promptModalConfirm">OK</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeNames = { "light": "Claro", "dark": "Escuro", "cupcake": "Cupcake", "bumblebee": "Abelha", "emerald": "Esmeralda", "corporate": "Corporativo", "synthwave": "Synthwave", "retro": "Retrô", "cyberpunk": "Cyberpunk", "valentine": "Namorados", "halloween": "Halloween", "garden": "Jardim", "forest": "Floresta", "aqua": "Água", "lofi": "Lofi", "pastel": "Pastel", "fantasy": "Fantasia", "wireframe": "Wireframe", "black": "Preto", "luxury": "Luxo", "dracula": "Drácula", "cmyk": "CMYK", "autumn": "Outono", "business": "Negócios", "acid": "Ácido", "lemonade": "Limonada", "night": "Noite", "coffee": "Café", "winter": "Inverno", "dim": "Pálido", "nord": "Nórdico", "sunset": "Pôr do Sol" };
        const daisyuiThemes = Object.keys(themeNames);

        const shoppingListContainer = document.getElementById('shoppingListContainer');
        const totalPriceElements = [document.getElementById('totalPrice'), document.getElementById('footerTotalPrice')];
        const itemCountElements = [document.getElementById('itemCount'), document.getElementById('footerItemCount')];
        const addItemForm = document.getElementById('addItemForm');
        const editModal = document.getElementById('edit_modal');
        const editItemForm = document.getElementById('editItemForm');
        const sectionModal = document.getElementById('section_modal');
        const sectionForm = document.getElementById('sectionForm');
        const settingsModal = document.getElementById('settings_modal');
        const themeSelectorContainer = document.getElementById('theme-selector-container');
        const confirmModal = document.getElementById('confirm_modal');
        const promptModal = document.getElementById('prompt_modal');

        const defaultSections = [
            { id: 'a1b2c3d4-e5f6-7890-1234-567890abcdef', name: 'Alimentos Gerais', icon: '🛒', parent: null, order: 0 },
            { id: 'b2c3d4e5-f6a7-8901-2345-67890abcdef1', name: 'Hortifrúti', icon: '🥕', parent: null, order: 1 },
            { id: 'c3d4e5f6-a7b8-9012-3456-7890abcdef12', name: 'Padaria', icon: '🍞', parent: null, order: 2 },
            { id: 'd4e5f6a7-b8c9-0123-4567-890abcdef123', name: 'Frios e Laticínios', icon: '🧀', parent: null, order: 3 },
            { id: 'e5f6a7b8-c9d0-1234-5678-90abcdef1234', name: 'Açougue e Peixaria', icon: '🍖', parent: null, order: 4 },
            { id: 'f6a7b8c9-d0e1-2345-6789-0abcdef12345', name: 'Produtos de Limpeza', icon: '🧽', parent: null, order: 5 },
            { id: 'a7b8c9d0-e1f2-3456-7890-bcdef1234567', name: 'Higiene Pessoal', icon: '🧴', parent: null, order: 6 }
        ];

        let shoppingList = [];
        let sections = [];
        let collapsedState = { sections: [], adder: true };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        const formatCompactCurrency = (value) => new Intl.NumberFormat('pt-BR', { notation: 'compact', style: 'currency', currency: 'BRL', minimumFractionDigits: 0, maximumFractionDigits: 1 }).format(value || 0);

        const showConfirmModal = (title, message, onConfirm) => {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').innerHTML = message;
            const confirmBtn = document.getElementById('confirmModalConfirm');
            const cancelBtn = document.getElementById('confirmModalCancel');
            confirmBtn.style.display = 'inline-flex';
            const confirmHandler = () => { onConfirm(); confirmModal.close(); cleanup(); };
            const cancelHandler = () => { confirmModal.close(); cleanup(); };
            const cleanup = () => {
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            confirmModal.showModal();
        };

        const showPromptModal = (title, message, initialValue, inputType, onConfirm) => {
            document.getElementById('promptModalTitle').textContent = title;
            document.getElementById('promptModalMessage').textContent = message;
            const input = document.getElementById('promptModalInput');
            input.value = initialValue;
            input.type = inputType;
            input.placeholder = (inputType === 'number') ? '0,00' : '...';
            const form = document.getElementById('promptForm');
            const cancelBtn = document.getElementById('promptModalCancel');
            const submitHandler = (e) => { e.preventDefault(); onConfirm(input.value); promptModal.close(); cleanup(); };
            const cancelHandler = () => { promptModal.close(); cleanup(); };
            const cleanup = () => {
                form.removeEventListener('submit', submitHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            form.addEventListener('submit', submitHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            promptModal.showModal();
            setTimeout(() => input.focus(), 50);
        };

        const loadState = () => {
            try {
                const savedList = localStorage.getItem('shoppingListAppV8');
                const savedSections = localStorage.getItem('sectionsV8');
                const savedCollapsed = localStorage.getItem('collapsedStateV8');
                if (savedList) shoppingList = JSON.parse(savedList);
                if (savedSections) {
                    sections = JSON.parse(savedSections);
                    sections.forEach(s => { if (!s.id) s.id = crypto.randomUUID(); });
                } else {
                    sections = defaultSections.map(s => ({...s}));
                }
                if (savedCollapsed) collapsedState = JSON.parse(savedCollapsed);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                shoppingList = [];
                sections = defaultSections.map(s => ({...s}));
                collapsedState = { sections: [], adder: true };
            }
        };

        const saveState = () => {
            try {
                localStorage.setItem('shoppingListAppV8', JSON.stringify(shoppingList));
                localStorage.setItem('sectionsV8', JSON.stringify(sections));
                localStorage.setItem('collapsedStateV8', JSON.stringify(collapsedState));
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
            }
        };

        const saveAndRender = () => {
            saveState();
            renderList();
            updateStats();
            updateAllDropdowns();
        };

        const getSectionById = (id) => sections.find(s => s.id === id);
        const getSubsections = (parentId) => sections.filter(s => s.parent === parentId).sort((a,b) => a.order - b.order);
        
        const renderList = () => {
            shoppingListContainer.innerHTML = '';
            if (shoppingList.length === 0) {
                shoppingListContainer.innerHTML = `<div class="card bg-base-100 shadow-md"><div class="card-body text-center py-12"><div class="text-6xl mb-4">🛒</div><h3 class="text-lg font-semibold mb-2">Sua lista está vazia</h3><p class="text-base-content/60">Use o formulário acima para adicionar seu primeiro item!</p></div></div>`;
                return;
            }
            const mainSections = sections.filter(s => !s.parent).sort((a, b) => a.order - b.order);
            mainSections.forEach(section => {
                const itemsInSection = shoppingList.filter(item => item.section === section.id && !item.subsection);
                const subsections = getSubsections(section.id);
                const hasContent = itemsInSection.length > 0 || subsections.some(sub => shoppingList.some(item => item.subsection === sub.id));
                if (!hasContent) return;
                const sectionElement = createSectionElement(section, itemsInSection, subsections);
                shoppingListContainer.appendChild(sectionElement);
            });
            initSortable();
        };

        function createSectionElement(section, items, subsections) {
            const isCollapsed = collapsedState.sections.includes(section.id);
            const allItems = shoppingList.filter(item => item.section === section.id);
            const sectionTotal = allItems.reduce((sum, item) => sum + ((item.price || 0) * item.quantity), 0);
            const completedItems = allItems.filter(item => item.inCart).length;
            const sectionElement = document.createElement('div');
            sectionElement.className = 'collapse collapse-arrow bg-base-100 shadow-md section-card';
            sectionElement.dataset.sectionId = section.id;
            sectionElement.innerHTML = `
                <input type="checkbox" ${isCollapsed ? '' : 'checked'} data-action="toggle-section-collapse" data-id="${section.id}" />
                <div class="collapse-title">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full gap-3">
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            <span class="text-3xl">${section.icon}</span>
                            <div class="min-w-0">
                                <div class="font-bold text-lg">${section.name}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="badge badge-sm section-badge">${completedItems}/${allItems.length} itens</span>
                                    ${sectionTotal > 0 ? `<span class="badge badge-sm badge-primary currency-display">${formatCompactCurrency(sectionTotal)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 self-end sm:self-center">
                            ${sectionTotal > 0 ? `<div class="text-right hidden sm:block"><div class="text-xs text-base-content/60">Total</div><div class="font-bold text-lg text-primary currency-display">${formatCurrency(sectionTotal)}</div></div>` : ''}
                        </div>
                    </div>
                </div>`;
            const collapseContent = document.createElement('div');
            collapseContent.className = 'collapse-content';
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'space-y-4 pt-3';
            if (items.length > 0) {
                const itemList = document.createElement('div');
                itemList.className = 'space-y-3 item-list';
                itemList.dataset.sectionId = section.id;
                items.sort((a, b) => a.order - b.order).map(createItemCard).forEach(card => itemList.appendChild(card));
                contentWrapper.appendChild(itemList);
            }
            subsections.forEach(subsection => {
                const subsectionItems = shoppingList.filter(item => item.subsection === subsection.id);
                if (subsectionItems.length > 0) {
                    contentWrapper.appendChild(createSubsectionElement(subsection, subsectionItems));
                }
            });
            collapseContent.appendChild(contentWrapper);
            sectionElement.appendChild(collapseContent);
            return sectionElement;
        }

        function createSubsectionElement(subsection, items) {
            const subsectionTotal = items.reduce((sum, item) => sum + ((item.price || 0) * item.quantity), 0);
            const completedItems = items.filter(item => item.inCart).length;
            const subsectionContainer = document.createElement('div');
            subsectionContainer.className = 'ml-2 sm:ml-6 mt-4';
            subsectionContainer.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full gap-3 mb-3 p-3 bg-base-200 rounded-lg border border-base-300">
                    <div class="flex items-center gap-3 min-w-0 flex-1">
                        <span class="text-xl">${subsection.icon}</span>
                        <div class="min-w-0">
                            <div class="font-semibold">${subsection.name}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="badge badge-xs subsection-badge">${completedItems}/${items.length} itens</span>
                                ${subsectionTotal > 0 ? `<span class="badge badge-xs badge-secondary currency-display">${formatCompactCurrency(subsectionTotal)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            const itemList = document.createElement('div');
            itemList.className = 'space-y-3 item-list';
            itemList.dataset.sectionId = subsection.parent;
            itemList.dataset.subsectionId = subsection.id;
            items.sort((a, b) => a.order - b.order).map(createItemCard).forEach(card => itemList.appendChild(card));
            subsectionContainer.appendChild(itemList);
            return subsectionContainer;
        }

        function createItemCard(item) {
            const isCompleted = item.inCart;
            const hasPrice = item.price > 0;
            const itemTotal = item.price * item.quantity;
            const card = document.createElement('div');
            card.className = 'card bg-base-200 item-card border border-base-300 hover:border-primary/30 transition-all duration-200';
            card.dataset.id = item.id;
            card.innerHTML = `
                <div class="card-body p-3 sm:p-4">
                    <div class="flex justify-between items-start gap-3">
                        <div class="flex items-start gap-3 flex-1 min-w-0">
                            <i class="fa-solid fa-grip-vertical drag-handle text-base-content/30 pt-1 hover:text-primary transition-colors"></i>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-semibold text-base break-words ${isCompleted ? 'line-through opacity-60' : ''}">${item.name}</h4>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4 mt-3">
                                    <div class="flex items-center gap-2">
                                        <span class="badge badge-outline">${item.quantity} ${item.unit}</span>
                                    </div>
                                    ${hasPrice ? `
                                    <div class="cursor-pointer hover:bg-base-300 p-2 rounded-lg transition-colors" data-action="edit-price" data-id="${item.id}">
                                        <div class="text-xs text-base-content/60">Preço unit.</div>
                                        <div class="font-bold text-primary currency-display">${formatCurrency(item.price)}</div>
                                        ${item.quantity > 1 ? `<div class="text-xs text-base-content/60">Total: ${formatCurrency(itemTotal)}</div>` : ''}
                                    </div>` : `
                                    <div class="join">
                                        <span class="join-item btn btn-xs btn-disabled bg-base-300">R$</span>
                                        <input type="number" step="0.01" min="0" placeholder="0,00" data-action="update-price-input" data-id="${item.id}" class="join-item input input-xs input-bordered w-24" />
                                    </div>`}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 items-center pt-1">
                            <div class="dropdown dropdown-end dropdown-bottom">
                                <button tabindex="0" class="btn btn-xs btn-circle btn-ghost hover:btn-primary"><i class="fa-solid fa-ellipsis-v"></i></button>
                                <ul tabindex="0" class="dropdown-content z-[40] menu p-2 shadow bg-base-100 rounded-box w-32 border border-base-300">
                                    <li><a data-action="edit-item" data-id="${item.id}"><i class="fa-solid fa-pen w-4"></i> Editar</a></li>
                                    <li><a data-action="remove-item" data-id="${item.id}"><i class="fa-solid fa-trash w-4 text-error"></i> Remover</a></li>
                                </ul>
                            </div>
                            ${hasPrice ? `
                            <button class="btn btn-xs ${isCompleted ? 'btn-success' : 'btn-primary btn-outline'} gap-1" data-action="toggle-cart-status" data-id="${item.id}">
                                ${isCompleted ? '<i class="fa-solid fa-check"></i><span class="hidden sm:inline">No Carrinho</span>' : '<i class="fa-solid fa-cart-plus"></i><span class="hidden sm:inline">Pôr no Carrinho</span>'}
                            </button>` : `<div class="h-6 w-6"></div>`}
                        </div>
                    </div>
                </div>`;
            return card;
        }
        
        function setupDropdown(dropdownId, hiddenInputId, onSelectCallback) {
            const dropdown = document.getElementById(dropdownId);
            const hiddenInput = document.getElementById(hiddenInputId);
            const button = dropdown.querySelector('button');
            const menu = dropdown.querySelector('ul');

            menu.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (target) {
                    const value = target.dataset.value;
                    const text = target.innerHTML;
                    hiddenInput.value = value;
                    button.querySelector('.truncate, button').innerHTML = text;
                    if (document.activeElement) document.activeElement.blur();
                    if (onSelectCallback) onSelectCallback(value);
                }
            });
        }

        function populateDropdown(dropdownId, items, hiddenInputId, placeholder, selectedValue) {
            const dropdown = document.getElementById(dropdownId);
            const button = dropdown.querySelector('button');
            const menu = dropdown.querySelector('ul');
            const hiddenInput = document.getElementById(hiddenInputId);

            menu.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.dataset.value = item.id;
                a.innerHTML = `${item.icon || ''} <span class="truncate">${item.name}</span>`;
                li.appendChild(a);
                menu.appendChild(li);
            });

            const selectedItem = items.find(item => item.id === selectedValue);
            if (selectedItem) {
                button.querySelector('.truncate').innerHTML = `${selectedItem.icon || ''} ${selectedItem.name}`;
                hiddenInput.value = selectedValue;
            } else {
                button.querySelector('.truncate').innerHTML = placeholder;
                hiddenInput.value = '';
            }
            button.disabled = items.length === 0 && !placeholder.includes("Nenhuma");
        }

        function updateAllDropdowns() {
            const mainSections = sections.filter(s => !s.parent).sort((a, b) => a.order - b.order);
            const lastUsedSection = localStorage.getItem('lastUsedSection');
            const lastUsedSubsection = localStorage.getItem('lastUsedSubsection');

            populateDropdown('itemSectionDropdown', mainSections, 'itemSection', 'Selecione uma seção', lastUsedSection);
            populateDropdown('editItemSectionDropdown', mainSections, 'editItemSection', 'Selecione uma seção', null);
            
            updateSubsectionDropdown('itemSubsectionDropdown', 'itemSubsection', lastUsedSection, lastUsedSubsection);
            updateSubsectionDropdown('editItemSubsectionDropdown', 'editItemSubsection', null, null);
        }

        function updateSubsectionDropdown(dropdownId, hiddenInputId, parentId, selectedValue) {
            const subsections = parentId ? getSubsections(parentId) : [];
            const items = [{id: '', name: 'Sem subseção', icon: '➖'}].concat(subsections);
            populateDropdown(dropdownId, items, hiddenInputId, 'Sem subseção', selectedValue);
        }

        const updateSectionModalUI = (parentId, isEditing = false) => {
            const modalTitle = document.getElementById('sectionModalTitle');
            const nameLabel = document.getElementById('sectionNameLabel');
            const feedbackDiv = document.getElementById('sectionTypeFeedback');
            const sectionNameInput = document.getElementById('sectionName');
            const editingPrefix = isEditing ? 'Editar' : 'Criar';

            if (!parentId) {
                modalTitle.textContent = `${editingPrefix} Seção Principal`;
                nameLabel.textContent = 'Nome da Nova Seção';
                sectionNameInput.placeholder = 'Ex: Bebidas';
                feedbackDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-folder-plus text-lg text-primary"></i>
                        <div>
                            Você está ${isEditing ? 'editando uma' : 'criando uma nova'} <strong>seção principal</strong>.
                        </div>
                    </div>`;
            } else {
                const parentSection = getSectionById(parentId);
                modalTitle.textContent = `${editingPrefix} Subseção`;
                nameLabel.textContent = 'Nome da Nova Subseção';
                sectionNameInput.placeholder = 'Ex: Refrigerantes';
                feedbackDiv.innerHTML = `
                     <div class="flex items-center gap-3">
                        <i class="fa-solid fa-turn-up fa-rotate-90 text-lg text-secondary"></i>
                        <div>
                            Você está ${isEditing ? 'editando uma' : 'criando uma nova'} <strong>subseção</strong> dentro de:
                            <div class="font-bold mt-1 badge badge-outline">${parentSection.icon} ${parentSection.name}</div>
                        </div>
                    </div>`;
            }
        };
        const initSortable = () => {
            document.querySelectorAll('.item-list').forEach(list => {
                new Sortable(list, {
                    group: 'shopping-list', animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const itemEl = evt.item;
                        const id = itemEl.dataset.id;
                        const newSectionId = itemEl.closest('.item-list').dataset.sectionId;
                        const newSubsectionId = itemEl.closest('.item-list').dataset.subsectionId || null;
                        
                        const movedItem = shoppingList.find(i => i.id === id);
                        if(movedItem) {
                            movedItem.section = newSectionId;
                            movedItem.subsection = newSubsectionId;
                        }

                        const orderedIds = Array.from(document.querySelectorAll('.item-card')).map(el => el.dataset.id);
                        shoppingList.sort((a, b) => orderedIds.indexOf(a.id) - orderedIds.indexOf(b.id));

                        saveAndRender();
                    }
                });
            });
        };
        const updateStats = () => {
            const total = shoppingList.reduce((sum, item) => sum + ((item.price || 0) * item.quantity), 0);
            totalPriceElements.forEach(el => el && (el.textContent = formatCurrency(total)));
            itemCountElements.forEach(el => el && (el.textContent = shoppingList.length));
        };
        const addItem = (name, quantity, unit, sectionId, subsectionId) => {
            const order = shoppingList.filter(i => i.section === sectionId && i.subsection === subsectionId).length;
            shoppingList.push({ id: crypto.randomUUID(), name, quantity, unit, section: sectionId, subsection: subsectionId || null, price: 0, inCart: false, order });
            localStorage.setItem('lastUsedSection', sectionId);
            localStorage.setItem('lastUsedSubsection', subsectionId || '');
            saveAndRender();
        };

        const updateItem = (id, updates) => {
            const item = shoppingList.find(i => i.id === id);
            if (item) { Object.assign(item, updates); saveAndRender(); }
        };

        const removeItem = (id) => {
            shoppingList = shoppingList.filter(i => i.id !== id);
            saveAndRender();
        };

        const addOrUpdateSection = (id, name, icon, parentId) => {
            if (id) {
                const section = getSectionById(id);
                if (section) { Object.assign(section, { name, icon, parent: parentId }); }
            } else {
                const newId = crypto.randomUUID();
                const order = sections.filter(s => s.parent === parentId).length;
                sections.push({ id: newId, name, icon: icon || '📦', parent: parentId, order });
            }
            saveAndRender();
        };

        const removeSection = (id) => {
            const section = getSectionById(id);
            if (!section) return;
            if (defaultSections.some(ds => ds.id === id)) {
                showConfirmModal('Ação Bloqueada', 'Não é possível remover seções padrão do sistema.', () => {});
                document.getElementById('confirmModalConfirm').style.display = 'none';
                return;
            }
            const itemsInSection = shoppingList.filter(i => i.section === id || i.subsection === id);
            let message = `Deseja realmente remover a seção "<b>${section.name}</b>"?`;
            if (itemsInSection.length > 0) message += `<br><br>Isso também removerá <b>${itemsInSection.length}</b> item(ns) permanentemente.`;
            showConfirmModal('Remover Seção', message, () => {
                shoppingList = shoppingList.filter(i => i.section !== id && i.subsection !== id);
                sections = sections.filter(s => s.id !== id && s.parent !== id);
                saveAndRender();
                if (settingsModal.open) renderSectionManager();
            });
        };

        addItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const itemName = document.getElementById('itemName').value.trim();
            const itemQuantity = parseFloat(document.getElementById('itemQuantity').value);
            const itemUnit = document.getElementById('itemUnit').value;
            const itemSection = document.getElementById('itemSection').value;
            const itemSubsection = document.getElementById('itemSubsection').value;
            if (itemName && !isNaN(itemQuantity) && itemQuantity > 0 && itemSection) {
                addItem(itemName, itemQuantity, itemUnit, itemSection, itemSubsection);
                addItemForm.reset();
                document.getElementById('itemQuantity').value = 1;
                document.getElementById('itemUnit').value = 'un';
                document.querySelector('#itemUnitDropdown button').innerHTML = 'Un <i class="fa-solid fa-chevron-down text-xs"></i>';
                document.getElementById('itemName').focus();
                saveAndRender();
            } else {
                alert("Por favor, preencha o nome, quantidade e selecione uma seção.");
            }
        });

        editItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editItemId').value;
            updateItem(id, {
                name: document.getElementById('editItemName').value.trim(),
                quantity: parseFloat(document.getElementById('editItemQuantity').value),
                unit: document.getElementById('editItemUnit').value,
                price: parseFloat(document.getElementById('editItemPrice').value) || 0,
                section: document.getElementById('editItemSection').value,
                subsection: document.getElementById('editItemSubsection').value || null
            });
            editModal.close();
        });

        sectionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('sectionId').value;
            const name = document.getElementById('sectionName').value.trim();
            const icon = document.getElementById('sectionIcon').value.trim();
            const parentId = document.getElementById('sectionParent').value || null;
            if (name) {
                addOrUpdateSection(id, name, icon, parentId);
                sectionModal.close();
                if (settingsModal.open) renderSectionManager();
            }
        });

        document.body.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) return;
            const { action, id } = actionTarget.dataset;
            const item = id ? shoppingList.find(i => i.id === id) : null;
            const section = id ? getSectionById(id) : null;
            switch (action) {
                case 'edit-item':
                    if (item) {
                        document.getElementById('editItemId').value = item.id;
                        document.getElementById('editItemName').value = item.name;
                        document.getElementById('editItemQuantity').value = item.quantity;
                        document.getElementById('editItemPrice').value = item.price || '';
                        
                        document.getElementById('editItemUnit').value = item.unit;
                        document.querySelector('#editItemUnitDropdown button').innerHTML = `${item.unit} <i class="fa-solid fa-chevron-down text-xs"></i>`;
                        
                        populateDropdown('editItemSectionDropdown', sections.filter(s => !s.parent), 'editItemSection', 'Selecione', item.section);
                        updateSubsectionDropdown('editItemSubsectionDropdown', 'editItemSubsection', item.section, item.subsection);

                        editModal.showModal();
                    }
                    break;
                case 'remove-item':
                    if (item) showConfirmModal('Remover Item', `Deseja realmente remover "<b>${item.name}</b>"?`, () => removeItem(id));
                    break;
                case 'edit-price':
                    if (item) showPromptModal('Editar Preço', `Digite o novo preço para "${item.name}":`, item.price, 'number', (newPrice) => {
                        if (newPrice !== null && !isNaN(parseFloat(newPrice))) updateItem(id, { price: parseFloat(newPrice) || 0 });
                    });
                    break;
                case 'toggle-cart-status':
                    if (item && item.price > 0) updateItem(id, { inCart: !item.inCart });
                    break;
                case 'open-section-modal':
                case 'open-section-modal-from-adder':
                    sectionForm.reset();
                    document.getElementById('sectionId').value = '';
                    const mainSectionsForNew = [{id: '', name: 'Nenhuma (Criar Seção Principal)', icon: '📁'}].concat(sections.filter(s => !s.parent));
                    populateDropdown('sectionParentDropdown', mainSectionsForNew, 'sectionParent', 'Nenhuma (Criar Seção Principal)', '');
                    updateSectionModalUI(null, false);
                    sectionModal.showModal();
                    setTimeout(() => document.getElementById('sectionName').focus(), 50);
                    break;
                case 'edit-section':
                    if (section) {
                        document.getElementById('sectionId').value = section.id;
                        document.getElementById('sectionName').value = section.name;
                        document.getElementById('sectionIcon').value = section.icon;
                        const parentId = section.parent || '';
                        const availableParents = [{id: '', name: 'Nenhuma (Tornar Seção Principal)', icon: '📁'}].concat(sections.filter(s => !s.parent && s.id !== section.id));
                        populateDropdown('sectionParentDropdown', availableParents, 'sectionParent', 'Nenhuma (Tornar Seção Principal)', parentId);
                        updateSectionModalUI(parentId, true);
                        sectionModal.showModal();
                        setTimeout(() => document.getElementById('sectionName').focus(), 50);
                    }
                    break;
                case 'remove-section':
                    if (section) removeSection(id);
                    break;
                case 'toggle-section-collapse':
                    const index = collapsedState.sections.indexOf(id);
                    index > -1 ? collapsedState.sections.splice(index, 1) : collapsedState.sections.push(id);
                    saveState();
                    break;
                case 'open-settings-modal':
                    renderThemeSelector();
                    renderSectionManager();
                    settingsModal.showModal();
                    break;
            }
        });

        document.body.addEventListener('blur', (e) => {
            const target = e.target.closest('[data-action="update-price-input"]');
            if (target) {
                const { id } = target.dataset;
                const value = e.target.value;
                if (value && !isNaN(parseFloat(value))) updateItem(id, { price: parseFloat(value) });
            }
        }, true);
        
        const renderThemeSelector = () => {
            const currentTheme = localStorage.getItem('theme') || 'cupcake';
            themeSelectorContainer.innerHTML = '';
            const themeJoin = document.createElement('div');
            themeJoin.className = 'join join-vertical w-full';
            daisyuiThemes.forEach(theme => {
                const button = document.createElement('button');
                button.className = `btn join-item ${theme === currentTheme ? 'btn-active' : ''}`;
                button.textContent = themeNames[theme];
                button.onclick = () => {
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    renderThemeSelector();
                };
                themeJoin.appendChild(button);
            });
            themeSelectorContainer.appendChild(themeJoin);
        };
        
        const renderSectionManager = () => {
            const container = document.getElementById('section-manager-container');
            container.innerHTML = '';
            const mainSections = sections.filter(s => !s.parent).sort((a, b) => a.order - b.order);
            if (mainSections.length === 0 && sections.length > 0) {
                container.textContent = 'Apenas subseções existem. Crie uma seção principal.';
                return;
            }
             if (sections.length === 0) {
                container.textContent = 'Nenhuma seção criada.';
                return;
            }
            mainSections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'p-2 bg-base-100 rounded-lg';
                let sectionHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 font-semibold truncate">
                            <span class="text-lg">${section.icon}</span>
                            <span class="truncate">${section.name}</span>
                        </div>
                        <div class="join">
                            <button class="btn btn-xs join-item" title="Editar Seção" data-action="edit-section" data-id="${section.id}"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-xs join-item" title="Remover Seção" data-action="remove-section" data-id="${section.id}"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                const subsections = getSubsections(section.id);
                if (subsections.length > 0) {
                    let subHTML = '<div class="ml-6 mt-2 space-y-1 border-l-2 border-base-300 pl-3">';
                    subsections.forEach(sub => {
                        subHTML += `
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2 text-sm truncate">
                                    <span class="text-base">${sub.icon}</span>
                                    <span class="truncate">${sub.name}</span>
                                </div>
                                <div class="join">
                                    <button class="btn btn-xs join-item" title="Editar Subseção" data-action="edit-section" data-id="${sub.id}"><i class="fa-solid fa-pen"></i></button>
                                    <button class="btn btn-xs join-item" title="Remover Subseção" data-action="remove-section" data-id="${sub.id}"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>`;
                    });
                    subHTML += '</div>';
                    sectionHTML += subHTML;
                }
                sectionDiv.innerHTML = sectionHTML;
                container.appendChild(sectionDiv);
            });
        };

        const init = () => {
            loadState();
            const currentTheme = localStorage.getItem('theme') || 'cupcake';
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            setupDropdown('itemUnitDropdown', 'itemUnit');
            setupDropdown('editItemUnitDropdown', 'editItemUnit');
            setupDropdown('itemSectionDropdown', 'itemSection', (value) => updateSubsectionDropdown('itemSubsectionDropdown', 'itemSubsection', value, ''));
            setupDropdown('editItemSectionDropdown', 'editItemSection', (value) => updateSubsectionDropdown('editItemSubsectionDropdown', 'editItemSubsection', value, ''));
            setupDropdown('itemSubsectionDropdown', 'itemSubsection');
            setupDropdown('editItemSubsectionDropdown', 'editItemSubsection');
            setupDropdown('sectionParentDropdown', 'sectionParent', (value) => {
                const sectionId = document.getElementById('sectionId').value;
                updateSectionModalUI(value || null, !!sectionId);
            });

            updateAllDropdowns();
            
            const adderToggle = document.getElementById('adder-toggle');
            if (adderToggle) {
                adderToggle.checked = collapsedState.adder;
                adderToggle.addEventListener('change', (e) => {
                    collapsedState.adder = e.target.checked;
                    saveState();
                });
            }
            
            saveAndRender();
            document.getElementById('itemName')?.focus();
        };

        init();
    });
    </script>
</body>
</html>