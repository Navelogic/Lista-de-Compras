<!DOCTYPE html>
<html lang="pt-BR" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Listas - poupe.com.br</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="favicon/site.webmanifest">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="poupe.com.br">
    <meta name="theme-color" content="#570df8">
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/9d986ddfce.js" crossorigin="anonymous"></script>
    <style>
        .card-template {
            border: 2px dashed oklch(var(--b3));
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-template:hover {
            border-color: oklch(var(--p));
            border-style: solid;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px -8px oklch(var(--p)/.2);
        }
        .hero-bg-gradient {
            background-color: oklch(var(--b2));
            background-image:
                radial-gradient(at 5% 15%, oklch(var(--p)/.15) 0px, transparent 50%),
                radial-gradient(at 85% 90%, oklch(var(--a)/.1) 0px, transparent 50%),
                radial-gradient(at 50% 50%, oklch(var(--b1)/.05) 0px, transparent 50%);
        }
        .list-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .list-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 14px 28px rgba(0,0,0,0.1), 0 10px 10px rgba(0,0,0,0.08);
        }
        .input-error {
            border-color: oklch(var(--er)) !important;
            box-shadow: 0 0 0 1px oklch(var(--er)) !important;
        }
        .input-error:focus {
            border-color: oklch(var(--er)) !important;
            box-shadow: 0 0 0 2px oklch(var(--er)/.2) !important;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen font-sans">
    <header class="sticky top-0 z-30 bg-base-100/80 backdrop-blur-md shadow-sm">
        <div class="navbar container mx-auto px-4">
            <div class="flex-1">
                <a href="index.html" class="text-2xl font-bold text-primary hover:opacity-80 transition-opacity">poupe.com.br</a>
            </div>
            <div class="flex-none gap-2">
                <button class="btn btn-ghost btn-circle" data-action="open-backup-modal" aria-label="Backup e Restaura√ß√£o">
                    <i class="fa-solid fa-download text-lg"></i>
                </button>
                <button class="btn btn-ghost btn-circle" data-action="open-settings-modal" aria-label="Abrir configura√ß√µes">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="container mx-auto p-4 md:p-8 space-y-16">
        <div class="hero rounded-2xl hero-bg-gradient shadow-lg overflow-hidden">
          <div class="hero-content flex-col lg:flex-row-reverse text-center lg:text-left p-8 md:p-12">
            <i class="fa-solid fa-cart-shopping text-primary/20 text-8xl lg:text-9xl -rotate-12 hidden lg:block"></i>
            <div class="max-w-xl">
              <h1 class="text-4xl md:text-5xl font-bold">Suas Listas de Compras</h1>
              <p class="py-6 text-base-content/80">Organize suas compras, planeje seus gastos e poupe. Crie uma nova lista ou comece com um de nossos modelos.</p>
              <button class="btn btn-primary btn-wide gap-2 shadow-md" id="createNewListBtn">
                <i class="fa-solid fa-plus"></i>
                Criar Nova Lista
              </button>
            </div>
          </div>
        </div>
        <div>
            <div class="flex items-center gap-4 mb-6">
                <span class="bg-primary/10 p-3 rounded-full"><i class="fa-solid fa-list-check text-primary text-xl"></i></span>
                <h2 class="text-3xl font-bold">Minhas Listas</h2>
            </div>
            <div id="listsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </div>
        <div>
            <div class="flex items-center gap-4 mb-6">
                <span class="bg-secondary/10 p-3 rounded-full"><i class="fa-solid fa-wand-magic-sparkles text-secondary text-xl"></i></span>
                <h2 class="text-3xl font-bold">Comece com um Modelo</h2>
            </div>
            <div id="templatesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </div>
        <div class="card bg-base-100 shadow-lg mt-12">
            <div class="card-body flex-col md:flex-row items-center gap-6 p-8">
                <div class="text-5xl text-secondary">
                    <i class="fa-solid fa-comments"></i>
                </div>
                <div class="flex-1 text-center md:text-left">
                    <h2 class="card-title text-xl">Sua opini√£o √© importante!</h2>
                    <p>Ajude-nos a melhorar o poupe.com.br respondendo nossa pesquisa r√°pida.</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="feedback_modal.showModal()">Responder Pesquisa</button>
                </div>
            </div>
        </div>
    </main>
    <footer class="footer p-10 bg-base-300 text-base-content mt-16">
        <aside>
            <p class="text-2xl font-bold">poupe.com.br</p>
            <p>onde cada real conta.</p>
        </aside>
        <nav>
            <h6 class="footer-title">Navega√ß√£o</h6>
            <a href="index.html" class="link link-hover">P√°gina Inicial</a>
            <a href="termosdeuso.html" class="link link-hover">Termos de uso</a>
            <a href="privacidade.html" class="link link-hover">Pol√≠tica de privacidade</a>
        </nav>
    </footer>
    <dialog id="list_name_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="listNameModalTitle">Criar Nova Lista</h3>
            <form id="listNameForm" method="dialog" class="py-4">
                <input type="text" id="listNameInput" placeholder="Ex: Compras do M√™s" class="input input-bordered w-full" required maxlength="50">
                <div class="modal-action mt-6">
                    <button type="button" class="btn" id="cancelListName">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    <dialog id="confirm_delete_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Excluir Lista</h3>
            <p class="py-4" id="confirmDeleteMessage">Voc√™ tem certeza que deseja excluir esta lista? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-action">
                <button class="btn" id="confirmDeleteCancel">Cancelar</button>
                <button class="btn btn-error" id="confirmDeleteConfirm">Excluir</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    <dialog id="settings_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configura√ß√µes de Apar√™ncia</h3>
            <div class="py-4 space-y-4">
                <div>
                    <h4 class="font-semibold mb-2">Escolha um tema</h4>
                    <div id="theme-selector-container" class="max-h-80 overflow-y-auto rounded-lg bg-base-200 p-2"></div>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    <dialog id="feedback_modal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
            <h3 class="font-bold text-2xl text-center">Ajude-nos a melhorar o poupe.com.br!</h3>
            <p class="py-4 text-center">Sua opini√£o √© muito importante. Responda nossa r√°pida pesquisa de feedback.</p>
            <div class="aspect-w-16 aspect-h-9">
                <iframe 
                src="https://docs.google.com/forms/d/e/1FAIpQLScwiDNL8aGKqxZLE5uF0zWhZlf0dssz4xZmwfsMXlnVFa_WsA/viewform?embedded=true" 
                width="100%" 
                height="450" 
                frameborder="0" 
                marginheight="0" 
                marginwidth="0">
                Carregando‚Ä¶
                </iframe>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    
    <!-- Modal de Backup/Export -->
    <dialog id="backup_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Backup e Restaura√ß√£o</h3>
            <div class="py-4 space-y-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Seus dados ficam apenas no seu dispositivo. Use essas op√ß√µes para fazer backup ou transferir suas listas.</span>
                </div>
                
                <div class="divider">Exportar Dados</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="btn btn-outline" id="exportJsonBtn">
                        <i class="fas fa-download"></i>
                        Exportar JSON
                    </button>
                    <button class="btn btn-outline" id="exportCsvBtn">
                        <i class="fas fa-file-csv"></i>
                        Exportar CSV
                    </button>
                </div>
                
                <div class="divider">Importar Dados</div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Selecione um arquivo de backup (JSON)</span>
                    </label>
                    <input type="file" id="importFileInput" accept=".json" class="file-input file-input-bordered w-full" />
                    <label class="label">
                        <span class="label-text-alt text-warning">‚ö†Ô∏è Isso substituir√° todas as suas listas atuais</span>
                    </label>
                </div>
                <button class="btn btn-warning w-full" id="importDataBtn" disabled>
                    <i class="fas fa-upload"></i>
                    Importar e Substituir Dados
                </button>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const LISTS_KEY = 'poupe_all_lists_V1';
        const listsContainer = document.getElementById('listsContainer');
        const templatesContainer = document.getElementById('templatesContainer');
        const createNewListBtn = document.getElementById('createNewListBtn');
        const listNameModal = document.getElementById('list_name_modal');
        const listNameForm = document.getElementById('listNameForm');
        const listNameInput = document.getElementById('listNameInput');
        const cancelListNameBtn = document.getElementById('cancelListName');
        const confirmDeleteModal = document.getElementById('confirm_delete_modal');
        const settingsModal = document.getElementById('settings_modal');
        const themeSelectorContainer = document.getElementById('theme-selector-container');
        
        const themeNames = { "light": "Claro", "dark": "Escuro", "cupcake": "Cupcake", "bumblebee": "Abelha", "emerald": "Esmeralda", "corporate": "Corporativo", "synthwave": "Synthwave", "retro": "Retr√¥", "cyberpunk": "Cyberpunk", "valentine": "Namorados", "halloween": "Halloween", "garden": "Jardim", "forest": "Floresta", "aqua": "Aqua", "lofi": "Lo-fi", "pastel": "Pastel", "fantasy": "Fantasia", "wireframe": "Wireframe", "black": "Preto", "luxury": "Luxo", "dracula": "Dr√°cula", "cmyk": "CMYK", "autumn": "Outono", "business": "Neg√≥cios", "acid": "√Åcido", "lemonade": "Limonada", "night": "Noite", "coffee": "Caf√©", "winter": "Inverno", "dim": "Escuro Suave", "nord": "Nord", "sunset": "P√¥r do Sol" };
        const daisyuiThemes = Object.keys(themeNames);
        
        // Fun√ß√µes de valida√ß√£o e sanitiza√ß√£o
        const sanitizeText = (text) => {
            if (!text || typeof text !== 'string') return '';
            return text
                .replace(/[<>"'&]/g, '') // Remove caracteres perigosos
                .replace(/[^a-zA-Z0-9\u00C0-\u017F \-.,()¬Æ‚Ñ¢¬∞%/]/g, '') // Permite mais caracteres √∫teis
                .trim()
                .substring(0, 100); // Limita tamanho
        };
        
        const validateListName = (name) => {
            const sanitized = sanitizeText(name);
            return {
                isValid: sanitized.length >= 2 && sanitized.length <= 60,
                sanitized,
                error: sanitized.length < 2 ? 'Nome deve ter pelo menos 2 caracteres' : 
                       sanitized.length > 60 ? 'Nome muito longo (m√°ximo 60 caracteres)' : null
            };
        };

        const templates = [
            {
                id: 'template_churrasco', name: 'Churrasco de Domingo!', icon: 'üçñ', description: 'Tudo para um churrasco perfeito com a galera.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Carnes', icon: 'ü•©', parent: null, order: 0 }, { id: crypto.randomUUID(), name: 'Acompanhamentos', icon: 'ü•ó', parent: null, order: 1 }, { id: crypto.randomUUID(), name: 'Bebidas', icon: 'üçª', parent: null, order: 2 },
                    ],
                    items: [
                        { name: 'Picanha', quantity: 2, unit: 'kg' }, { name: 'Lingui√ßa Toscana', quantity: 1, unit: 'kg' }, { name: 'Asa de Frango', quantity: 1, unit: 'kg' }, { name: 'P√£o de Alho', quantity: 2, unit: 'pct' }, { name: 'Carv√£o', quantity: 1, unit: 'pct' }, { name: 'Farofa Pronta', quantity: 1, unit: 'pct' }, { name: 'Vinagrete', quantity: 1, unit: 'un' }, { name: 'Cerveja', quantity: 12, unit: 'un' }, { name: 'Refrigerante', quantity: 2, unit: 'l' },
                    ]
                }
            },
            {
                id: 'template_cesta_basica', name: 'Cesta B√°sica Essencial', icon: 'üß∫', description: 'Os itens essenciais para abastecer a despensa.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Mercearia', icon: 'üõí', parent: null, order: 0 }, { id: crypto.randomUUID(), name: 'Limpeza', icon: 'ÔøΩ', parent: null, order: 1 }, { id: crypto.randomUUID(), name: 'Higiene', icon: 'üß¥', parent: null, order: 2 },
                    ],
                    items: [
                        { name: 'Arroz', quantity: 5, unit: 'kg' }, { name: 'Feij√£o', quantity: 2, unit: 'kg' }, { name: '√ìleo de Soja', quantity: 1, unit: 'un' }, { name: 'A√ß√∫car', quantity: 1, unit: 'kg' }, { name: 'Caf√©', quantity: 1, unit: 'pct' }, { name: 'Sal', quantity: 1, unit: 'kg' }, { name: 'Macarr√£o', quantity: 2, unit: 'pct' }, { name: 'Molho de Tomate', quantity: 2, unit: 'un' }, { name: 'Sab√£o em P√≥', quantity: 1, unit: 'cx' }, { name: 'Detergente', quantity: 2, unit: 'un' }, { name: 'Papel Higi√™nico', quantity: 1, unit: 'pct' }, { name: 'Creme Dental', quantity: 1, unit: 'un' },
                    ]
                }
            }
        ];

        let allLists = [];
        let currentTemplateData = null;
        let currentEditingListId = null;

        const loadLists = () => {
            try {
                const saved = localStorage.getItem(LISTS_KEY);
                allLists = saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error("Erro ao carregar listas:", e);
                allLists = [];
            }
        };

        const saveLists = () => {
            localStorage.setItem(LISTS_KEY, JSON.stringify(allLists));
        };

        const formatDate = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
        };

        const render = () => {
            listsContainer.innerHTML = '';
            templatesContainer.innerHTML = '';
            allLists.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (allLists.length === 0) {
                listsContainer.innerHTML = `
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 card bg-base-100/50 text-center p-8 border-2 border-dashed">
                        <div class="card-body items-center">
                            <i class="fa-solid fa-folder-open text-4xl text-base-content/30 mb-4"></i>
                            <h2 class="card-title">Nenhuma lista encontrada!</h2>
                            <p class="text-base-content/70">Crie uma nova lista ou use um modelo abaixo para come√ßar.</p>
                        </div>
                    </div>`;
            } else {
                allLists.forEach(list => {
                    const itemCount = list.items?.length || 0;
                    const listCard = document.createElement('div');
                    listCard.className = 'card bg-base-100 shadow-lg list-card';
                    listCard.innerHTML = `
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <h2 class="card-title truncate pr-2">${list.name}</h2>
                                <div class="dropdown dropdown-end">
                                    <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle" aria-label="Mais op√ß√µes">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-40">
                                        <li><a data-action="edit" data-id="${list.id}"><i class="fa-solid fa-pen w-4"></i>Editar nome</a></li>
                                        <li><a class="text-error" data-action="delete" data-id="${list.id}"><i class="fa-solid fa-trash w-4"></i>Excluir</a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-sm text-base-content/60">${itemCount} item(ns)</p>
                            <span class="text-xs text-base-content/40 mt-2">Criada em: ${formatDate(list.createdAt)}</span>
                            <div class="card-actions justify-end mt-4">
                                <button class="btn btn-primary w-full" data-action="open" data-id="${list.id}">
                                    Abrir Lista <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>`;
                    listsContainer.appendChild(listCard);
                });
            }

            templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'card card-template bg-base-100 cursor-pointer';
                templateCard.dataset.action = 'use-template';
                templateCard.dataset.id = template.id;
                templateCard.innerHTML = `
                    <div class="card-body items-center text-center p-6">
                        <div class="text-5xl mb-3">${template.icon}</div>
                        <h2 class="card-title">${template.name}</h2>
                        <p class="text-sm text-base-content/70">${template.description}</p>
                    </div>`;
                templatesContainer.appendChild(templateCard);
            });
        };

        const handleCreateList = (name) => {
            const newList = {
                id: crypto.randomUUID(), name: name.trim(), createdAt: new Date().toISOString(),
                items: [], sections: [], collapsedState: { sections: [], adder: true }
            };

            if (currentTemplateData) {
                const templateSections = currentTemplateData.sections.map(s => ({...s, id: crypto.randomUUID()}));
                const sectionMap = new Map(currentTemplateData.sections.map((s, i) => [i, templateSections[i].id]));
                newList.sections = templateSections;
                newList.items = currentTemplateData.items.map(item => ({
                    ...item, id: crypto.randomUUID(), section: sectionMap.get(0),
                    subsection: null, price: 0, inCart: false, order: 0
                }));
            }
            allLists.push(newList);
            saveLists();
            window.location.href = `lista.html?listId=${newList.id}`;
        };

        const renderThemeSelector = () => {
            const currentTheme = localStorage.getItem('theme') || 'cupcake';
            themeSelectorContainer.innerHTML = '';
            const themeGrid = document.createElement('div');
            themeGrid.className = 'grid grid-cols-2 gap-2';
            daisyuiThemes.forEach(theme => {
                const button = document.createElement('button');
                button.className = `btn btn-outline w-full ${theme === currentTheme ? 'btn-active' : ''}`;
                button.textContent = themeNames[theme];
                button.onclick = () => {
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    renderThemeSelector();
                };
                themeGrid.appendChild(button);
            });
            themeSelectorContainer.appendChild(themeGrid);
        };

        createNewListBtn.addEventListener('click', () => {
            currentEditingListId = null;
            currentTemplateData = null;
            listNameInput.value = '';
            document.getElementById('listNameModalTitle').textContent = 'Criar Nova Lista';
            listNameForm.querySelector('button[type="submit"]').textContent = 'Salvar e Abrir';
            listNameModal.showModal();
            listNameInput.focus();
        });

        listNameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = listNameInput.value;
            
            // Valida√ß√£o do nome da lista
            const nameValidation = validateListName(name);
            if (!nameValidation.isValid) {
                showListNameError(nameValidation.error);
                return;
            }

            if (currentEditingListId) {
                const listToUpdate = allLists.find(l => l.id === currentEditingListId);
                if (listToUpdate) {
                    listToUpdate.name = nameValidation.sanitized;
                    saveLists();
                    render();
                }
                currentEditingListId = null;
            } else {
                handleCreateList(nameValidation.sanitized);
            }
            listNameModal.close();
        });
        
        const showListNameError = (message) => {
            const submitButton = listNameForm.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = message;
            submitButton.classList.add('btn-error');
            setTimeout(() => {
                submitButton.textContent = originalText;
                submitButton.classList.remove('btn-error');
            }, 3000);
        };

        cancelListNameBtn.addEventListener('click', () => listNameModal.close());
        
        // Valida√ß√£o em tempo real para nome da lista
        listNameInput.addEventListener('input', (e) => {
            const validation = validateListName(e.target.value);
            e.target.setCustomValidity(validation.isValid ? '' : validation.error);
            e.target.classList.toggle('input-error', !validation.isValid);
            e.target.value = sanitizeText(e.target.value);
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, id } = target.dataset;

            switch(action) {
                case 'open':
                    window.location.href = `lista.html?listId=${id}`;
                    break;
                case 'edit': {
                    const listToEdit = allLists.find(l => l.id === id);
                    if (listToEdit) {
                        currentEditingListId = id;
                        currentTemplateData = null;
                        document.getElementById('listNameModalTitle').textContent = 'Editar Nome da Lista';
                        listNameInput.value = listToEdit.name;
                        listNameForm.querySelector('button[type="submit"]').textContent = 'Salvar';
                        listNameModal.showModal();
                        listNameInput.focus();
                    }
                    break;
                }
                case 'delete': {
                    const listToDelete = allLists.find(l => l.id === id);
                    if (listToDelete) {
                        document.getElementById('confirmDeleteMessage').innerHTML = `Voc√™ tem certeza que deseja excluir a lista "<b>${listToDelete.name}</b>"? Esta a√ß√£o n√£o pode ser desfeita.`;
                        const confirmBtn = document.getElementById('confirmDeleteConfirm');
                        
                        const newConfirmBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                        
                        newConfirmBtn.addEventListener('click', () => {
                            allLists = allLists.filter(l => l.id !== id);
                            saveLists();
                            render();
                            confirmDeleteModal.close();
                        }, { once: true });

                        document.getElementById('confirmDeleteCancel').onclick = () => confirmDeleteModal.close();
                        confirmDeleteModal.showModal();
                    }
                    break;
                }
                case 'use-template': {
                    const template = templates.find(t => t.id === id);
                    if (template) {
                        currentEditingListId = null;
                        currentTemplateData = template.data;
                        listNameInput.value = template.name;
                        document.getElementById('listNameModalTitle').textContent = 'Usar Modelo';
                        listNameForm.querySelector('button[type="submit"]').textContent = 'Salvar e Abrir';
                        listNameModal.showModal();
                        listNameInput.focus();
                        listNameInput.select();
                    }
                    break;
                }
                case 'open-settings-modal':
                    renderThemeSelector();
                    settingsModal.showModal();
                    break;
                case 'open-backup-modal':
                    document.getElementById('backup_modal').showModal();
                    break;
            }
        });

        // Funcionalidades de Backup/Export/Import
        const exportToJson = () => {
            const data = {
                lists: allLists,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poupe-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const exportToCsv = () => {
            let csvContent = 'Lista,Se√ß√£o,Item,Quantidade,Pre√ßo,Comprado\n';
            allLists.forEach(list => {
                list.sections.forEach(section => {
                    section.items.forEach(item => {
                        const row = [
                            `"${list.name}"`,
                            `"${section.name}"`,
                            `"${item.name}"`,
                            item.quantity || 1,
                            item.price || '',
                            item.purchased ? 'Sim' : 'N√£o'
                        ].join(',');
                        csvContent += row + '\n';
                    });
                });
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poupe-listas-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const importFromJson = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.lists && Array.isArray(data.lists)) {
                        allLists = data.lists;
                        saveLists();
                        render();
                        alert('Dados importados com sucesso!');
                        document.getElementById('backup_modal').close();
                    } else {
                        alert('Arquivo inv√°lido. Certifique-se de que √© um backup v√°lido do poupe.com.br');
                    }
                } catch (error) {
                    alert('Erro ao ler o arquivo. Certifique-se de que √© um arquivo JSON v√°lido.');
                }
            };
            reader.readAsText(file);
        };

        // Event listeners para backup/export/import
        document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        
        const importFileInput = document.getElementById('importFileInput');
        const importDataBtn = document.getElementById('importDataBtn');
        
        importFileInput.addEventListener('change', (e) => {
            importDataBtn.disabled = !e.target.files.length;
        });
        
        importDataBtn.addEventListener('click', () => {
            const file = importFileInput.files[0];
            if (file && confirm('Isso substituir√° todas as suas listas atuais. Tem certeza?')) {
                importFromJson(file);
            }
        });

        const init = () => {
            const currentTheme = localStorage.getItem('theme') || 'cupcake';
            document.documentElement.setAttribute('data-theme', currentTheme);
            loadLists();
            render();
        };

        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registrado com sucesso:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Falha ao registrar SW:', error);
                    });
            });
        }

        init();
    });
    </script>
</body>
</html>