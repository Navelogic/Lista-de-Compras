<!DOCTYPE html>
<html lang="pt-BR" data-theme="emerald">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Minhas Listas - poupe.com.br</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="favicon/site.webmanifest">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="poupe.com.br">
    <meta name="theme-color" content="#570df8">
    
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/9d986ddfce.js" crossorigin="anonymous"></script>
    <style>
        .card-template {
            border: 2px dashed oklch(var(--b3));
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-template:hover {
            border-color: oklch(var(--p));
            border-style: solid;
            transform: translateY(-5px) scale(1.02);
        }
        .hero-bg-gradient {
            background-color: oklch(var(--b2));
            background-image:
                radial-gradient(at 5% 15%, oklch(var(--p)/.15) 0px, transparent 50%),
                radial-gradient(at 85% 90%, oklch(var(--a)/.1) 0px, transparent 50%),
                radial-gradient(at 50% 50%, oklch(var(--b1)/.05) 0px, transparent 50%);
        }
        .list-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .list-card:hover {
            transform: translateY(-5px);
        }
        .input-error {
            border-color: oklch(var(--er)) !important;
            box-shadow: 0 0 0 1px oklch(var(--er)) !important;
        }
        .input-error:focus {
            border-color: oklch(var(--er)) !important;
            box-shadow: 0 0 0 2px oklch(var(--er)/.2) !important;
        }
        
        /* Microinterações e feedback visual */
        .btn {
            transition: all 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn:active {
            transform: translateY(0);
        }
        
        .modal-box {
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-success {
            animation: pulseSuccess 0.6s ease-out;
        }
        
        @keyframes pulseSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen font-sans">
    <header class="sticky top-0 z-30 bg-base-100 border-b border-base-300">
        <div class="navbar container mx-auto px-3 sm:px-4 md:px-8">
            <div class="flex-1">
                <a href="index.html" class="text-xl sm:text-2xl font-bold text-primary hover:opacity-80 transition-all duration-200 hover:scale-105">poupe.com.br</a>
            </div>
            <div class="flex-none gap-2">
                <button class="btn btn-ghost btn-circle hover:btn-primary hover:scale-105 transition-all duration-200" data-action="open-backup-modal" aria-label="Backup e Restauração">
                    <i class="fa-solid fa-download text-base sm:text-lg"></i>
                </button>
                <button class="btn btn-ghost btn-circle hover:btn-primary hover:scale-105 transition-all duration-200" data-action="open-settings-modal" aria-label="Abrir configurações">
                    <i class="fa-solid fa-gear text-base sm:text-lg"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="container mx-auto px-3 sm:px-4 md:px-8 py-4 md:py-6 space-y-12 md:space-y-16">
        <div class="hero rounded-2xl hero-bg-gradient transition-all duration-300 overflow-hidden">
        <div class="hero-content flex-col lg:flex-row-reverse text-center lg:text-left p-6 sm:p-8 md:p-12">
            <i class="fa-solid fa-cart-shopping text-primary/20 text-6xl sm:text-8xl lg:text-9xl -rotate-12 hidden lg:block transition-transform duration-500 hover:rotate-0"></i>
            <div class="max-w-xl">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tight tracking-tight mb-4">Suas Listas de Compras</h1>
            <p class="py-4 sm:py-6 text-base-content/80 text-base sm:text-lg leading-relaxed">Organize suas compras, planeje seus gastos e poupe. Crie uma nova lista ou comece com um de nossos modelos.</p>
            <button class="btn btn-primary btn-wide gap-2 hover:scale-105 transition-all duration-200 text-base font-semibold" id="createNewListBtn">
                <i class="fa-solid fa-plus"></i>
                Criar Nova Lista
            </button>
            </div>
        </div>
        </div>
        <div>
            <div class="flex items-center gap-4 mb-6 sm:mb-8">
                <span class="bg-primary/10 p-3 rounded-full hover:bg-primary/20 transition-all duration-200 hover:scale-110"><i class="fa-solid fa-list-check text-primary text-lg sm:text-xl"></i></span>
                <h2 class="text-2xl sm:text-3xl font-bold leading-tight tracking-tight">Minhas Listas</h2>
            </div>
            <div id="listsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            </div>
        </div>
        <div>
            <div class="flex items-center gap-4 mb-6 sm:mb-8">
                <span class="bg-secondary/10 p-3 rounded-full hover:bg-secondary/20 transition-all duration-200 hover:scale-110"><i class="fa-solid fa-wand-magic-sparkles text-secondary text-lg sm:text-xl"></i></span>
                <h2 class="text-2xl sm:text-3xl font-bold leading-tight tracking-tight">Comece com um Modelo</h2>
            </div>
            <div id="templatesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            </div>
        </div>
        <div class="card bg-base-100 mt-12">
            <div class="card-body flex-col md:flex-row items-center gap-6 p-8">
                <div class="text-5xl text-secondary">
                    <i class="fa-solid fa-comments"></i>
                </div>
                <div class="flex-1 text-center md:text-left">
                    <h2 class="card-title text-xl">Sua opinião é importante!</h2>
                    <p>Ajude-nos a melhorar o poupe.com.br respondendo nossa pesquisa rápida.</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-secondary" onclick="feedback_modal.showModal()">Responder Pesquisa</button>
                </div>
            </div>
        </div>
    </main>
    <footer class="footer p-10 bg-base-300 text-base-content mt-16">
        <aside>
            <p class="text-2xl font-bold">poupe.com.br</p>
            <p>onde cada real conta.</p>
        </aside>
        <nav>
            <h6 class="footer-title">Navegação</h6>
            <a href="index.html" class="link link-hover">Página Inicial</a>
            <a href="termosdeuso.html" class="link link-hover">Termos de uso</a>
            <a href="privacidade.html" class="link link-hover">Política de privacidade</a>
        </nav>
    </footer>
    <dialog id="list_name_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="listNameModalTitle">Criar Nova Lista</h3>
            <form id="listNameForm" method="dialog" class="py-4">
                <input type="text" id="listNameInput" placeholder="Ex: Compras do Mês" class="input input-bordered w-full focus:input-primary focus:scale-105 transition-all duration-200 text-base" required maxlength="50">
                <div class="modal-action mt-6">
                    <button type="button" class="btn hover:scale-105 transition-all duration-200" id="cancelListName">Cancelar</button>
                    <button type="submit" class="btn btn-primary hover:scale-105 transition-all duration-200 font-semibold">Salvar</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    <dialog id="confirm_delete_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Excluir Lista</h3>
            <p class="py-4 text-base leading-relaxed" id="confirmDeleteMessage">Você tem certeza que deseja excluir esta lista? Esta ação não pode ser desfeita.</p>
            <div class="modal-action">
                <button class="btn hover:scale-105 transition-all duration-200" id="confirmDeleteCancel">Cancelar</button>
                <button class="btn btn-error hover:scale-105 transition-all duration-200 font-semibold" id="confirmDeleteConfirm">Excluir</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    <dialog id="settings_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Configurações de Aparência</h3>
            <div class="py-4 space-y-4">
                <div>
                    <h4 class="font-semibold mb-2">Escolha um tema</h4>
                    <div id="theme-selector-container" class="max-h-80 overflow-y-auto rounded-lg bg-base-200 p-2"></div>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    <dialog id="feedback_modal" class="modal">
        <div class="modal-box w-11/12 max-w-3xl">
            <h3 class="font-bold text-2xl text-center">Ajude-nos a melhorar o poupe.com.br!</h3>
            <p class="py-4 text-center">Sua opinião é muito importante. Responda nossa rápida pesquisa de feedback.</p>
            <div class="aspect-w-16 aspect-h-9">
                <iframe 
                src="https://docs.google.com/forms/d/e/1FAIpQLScwiDNL8aGKqxZLE5uF0zWhZlf0dssz4xZmwfsMXlnVFa_WsA/viewform?embedded=true" 
                width="100%" 
                height="450" 
                frameborder="0" 
                marginheight="0" 
                marginwidth="0">
                Carregando…
                </iframe>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    
    <!-- Modal de Backup/Export -->
    <dialog id="backup_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Backup e Restauração</h3>
            <div class="py-4 space-y-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Seus dados ficam apenas no seu dispositivo. Use essas opções para fazer backup ou transferir suas listas.</span>
                </div>
                
                <div class="divider">Exportar Dados</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="btn btn-outline hover:btn-primary hover:scale-105 transition-all duration-200" id="exportJsonBtn">
                        <i class="fas fa-download"></i>
                        Exportar JSON
                    </button>
                    <button class="btn btn-outline hover:btn-secondary hover:scale-105 transition-all duration-200" id="exportCsvBtn">
                        <i class="fas fa-file-csv"></i>
                        Exportar CSV
                    </button>
                </div>
                
                <div class="divider">Importar Dados</div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Selecione um arquivo de backup (JSON)</span>
                    </label>
                    <input type="file" id="importFileInput" accept=".json" class="file-input file-input-bordered w-full focus:file-input-primary transition-all duration-200" />
                    <label class="label">
                        <span class="label-text-alt text-warning font-medium">⚠️ Isso substituirá todas as suas listas atuais</span>
                    </label>
                </div>
                <button class="btn btn-warning w-full hover:scale-105 hover:shadow-lg transition-all duration-200 font-semibold" id="importDataBtn" disabled>
                    <i class="fas fa-upload"></i>
                    Importar e Substituir Dados
                </button>
            </div>
            <div class="modal-action">
                <form method="dialog"><button class="btn">Fechar</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
    </dialog>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const LISTS_KEY = 'poupe_all_lists_V1';
        const listsContainer = document.getElementById('listsContainer');
        const templatesContainer = document.getElementById('templatesContainer');
        const createNewListBtn = document.getElementById('createNewListBtn');
        const listNameModal = document.getElementById('list_name_modal');
        const listNameForm = document.getElementById('listNameForm');
        const listNameInput = document.getElementById('listNameInput');
        const cancelListNameBtn = document.getElementById('cancelListName');
        const confirmDeleteModal = document.getElementById('confirm_delete_modal');
        const settingsModal = document.getElementById('settings_modal');
        const themeSelectorContainer = document.getElementById('theme-selector-container');
        
        const themeNames = { "light": "Claro", "dark": "Escuro", "cupcake": "Cupcake", "bumblebee": "Abelha", "emerald": "Esmeralda", "corporate": "Corporativo", "synthwave": "Synthwave", "retro": "Retrô", "cyberpunk": "Cyberpunk", "valentine": "Namorados", "halloween": "Halloween", "garden": "Jardim", "forest": "Floresta", "aqua": "Aqua", "lofi": "Lo-fi", "pastel": "Pastel", "fantasy": "Fantasia", "wireframe": "Wireframe", "black": "Preto", "luxury": "Luxo", "dracula": "Drácula", "cmyk": "CMYK", "autumn": "Outono", "business": "Negócios", "acid": "Ácido", "lemonade": "Limonada", "night": "Noite", "coffee": "Café", "winter": "Inverno", "dim": "Escuro Suave", "nord": "Nord", "sunset": "Pôr do Sol" };
        const daisyuiThemes = Object.keys(themeNames);
        
        // Funções de validação e sanitização
        const sanitizeText = (text) => {
            if (!text || typeof text !== 'string') return '';
            return text
                .replace(/[<>"'&]/g, '') // Remove caracteres perigosos
                .replace(/[^a-zA-Z0-9\u00C0-\u017F \-.,()®™°%/]/g, '') // Permite mais caracteres úteis
                .trim()
                .substring(0, 100); // Limita tamanho
        };
        
        const validateListName = (name) => {
            const sanitized = sanitizeText(name);
            return {
                isValid: sanitized.length >= 2 && sanitized.length <= 60,
                sanitized,
                error: sanitized.length < 2 ? 'Nome deve ter pelo menos 2 caracteres' : 
                       sanitized.length > 60 ? 'Nome muito longo (máximo 60 caracteres)' : null
            };
        };

        const templates = [
            {
                id: 'template_churrasco', name: 'Churrasco de Domingo!', icon: '🍖', description: 'Tudo para um churrasco perfeito com a galera.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Carnes', icon: '🥩', parent: null, order: 0 }, { id: crypto.randomUUID(), name: 'Acompanhamentos', icon: '🥗', parent: null, order: 1 }, { id: crypto.randomUUID(), name: 'Bebidas', icon: '🍻', parent: null, order: 2 },
                    ],
                    items: [
                        { name: 'Picanha', quantity: 2, unit: 'kg' }, { name: 'Linguiça Toscana', quantity: 1, unit: 'kg' }, { name: 'Asa de Frango', quantity: 1, unit: 'kg' }, { name: 'Pão de Alho', quantity: 2, unit: 'pct' }, { name: 'Carvão', quantity: 1, unit: 'pct' }, { name: 'Farofa Pronta', quantity: 1, unit: 'pct' }, { name: 'Vinagrete', quantity: 1, unit: 'un' }, { name: 'Cerveja', quantity: 12, unit: 'un' }, { name: 'Refrigerante', quantity: 2, unit: 'l' },
                    ]
                }
            },
            {
                id: 'template_cesta_basica', name: 'Cesta Básica Essencial', icon: '🧺', description: 'Os itens essenciais para abastecer a despensa.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Mercearia', icon: '🛒', parent: null, order: 0 }, { id: crypto.randomUUID(), name: 'Limpeza', icon: '🧼', parent: null, order: 1 }, { id: crypto.randomUUID(), name: 'Higiene', icon: '🧴', parent: null, order: 2 },
                    ],
                    items: [
                        { name: 'Arroz', quantity: 5, unit: 'kg' }, { name: 'Feijão', quantity: 2, unit: 'kg' }, { name: 'Óleo de Soja', quantity: 1, unit: 'un' }, { name: 'Açúcar', quantity: 1, unit: 'kg' }, { name: 'Café', quantity: 1, unit: 'pct' }, { name: 'Sal', quantity: 1, unit: 'kg' }, { name: 'Macarrão', quantity: 2, unit: 'pct' }, { name: 'Molho de Tomate', quantity: 2, unit: 'un' }, { name: 'Sabão em Pó', quantity: 1, unit: 'cx' }, { name: 'Detergente', quantity: 2, unit: 'un' }, { name: 'Papel Higiênico', quantity: 1, unit: 'pct' }, { name: 'Creme Dental', quantity: 1, unit: 'un' },
                    ]
                }
            },
            {
                id: 'template_solteiro', name: 'Compras para Solteiro(a)', icon: '👤', description: 'Porções individuais e práticas para quem mora sozinho.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Básicos', icon: '🛒', parent: null, order: 0 },
                        { id: crypto.randomUUID(), name: 'Proteínas', icon: '🥩', parent: null, order: 1 },
                        { id: crypto.randomUUID(), name: 'Lanches', icon: '🥪', parent: null, order: 2 }
                    ],
                    items: [
                        { name: 'Arroz', quantity: 1, unit: 'kg' }, { name: 'Feijão', quantity: 500, unit: 'g' }, { name: 'Óleo', quantity: 1, unit: 'un' }, { name: 'Sal', quantity: 1, unit: 'un' }, { name: 'Açúcar', quantity: 1, unit: 'kg' }, { name: 'Café', quantity: 1, unit: 'pct' }, { name: 'Leite', quantity: 1, unit: 'l' }, { name: 'Ovos', quantity: 6, unit: 'un' }, { name: 'Frango', quantity: 1, unit: 'kg' }, { name: 'Pão de Forma', quantity: 1, unit: 'un' }, { name: 'Queijo', quantity: 200, unit: 'g' }, { name: 'Presunto', quantity: 200, unit: 'g' }, { name: 'Iogurte', quantity: 4, unit: 'un' }, { name: 'Banana', quantity: 6, unit: 'un' }
                    ]
                }
            },
            {
                id: 'template_casal', name: 'Compras para Casal', icon: '👫', description: 'Quantidades ideais para duas pessoas.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Mercearia', icon: '🛒', parent: null, order: 0 },
                        { id: crypto.randomUUID(), name: 'Carnes', icon: '🥩', parent: null, order: 1 },
                        { id: crypto.randomUUID(), name: 'Hortifruti', icon: '🥬', parent: null, order: 2 },
                        { id: crypto.randomUUID(), name: 'Laticínios', icon: '🥛', parent: null, order: 3 }
                    ],
                    items: [
                        { name: 'Arroz', quantity: 2, unit: 'kg' }, { name: 'Feijão', quantity: 1, unit: 'kg' }, { name: 'Macarrão', quantity: 2, unit: 'pct' }, { name: 'Molho de Tomate', quantity: 2, unit: 'un' }, { name: 'Óleo', quantity: 1, unit: 'un' }, { name: 'Açúcar', quantity: 1, unit: 'kg' }, { name: 'Café', quantity: 1, unit: 'pct' }, { name: 'Sal', quantity: 1, unit: 'un' }, { name: 'Frango', quantity: 2, unit: 'kg' }, { name: 'Carne Moída', quantity: 1, unit: 'kg' }, { name: 'Ovos', quantity: 12, unit: 'un' }, { name: 'Leite', quantity: 2, unit: 'l' }, { name: 'Queijo', quantity: 300, unit: 'g' }, { name: 'Iogurte', quantity: 6, unit: 'un' }, { name: 'Tomate', quantity: 1, unit: 'kg' }, { name: 'Cebola', quantity: 1, unit: 'kg' }, { name: 'Alface', quantity: 2, unit: 'un' }, { name: 'Banana', quantity: 1, unit: 'kg' }, { name: 'Maçã', quantity: 1, unit: 'kg' }
                    ]
                }
            },
            {
                id: 'template_familia', name: 'Família (4 pessoas)', icon: '👨‍👩‍👧‍👦', description: 'Compras completas para família de 4 pessoas.',
                data: {
                    sections: [
                        { id: crypto.randomUUID(), name: 'Mercearia', icon: '🛒', parent: null, order: 0 },
                        { id: crypto.randomUUID(), name: 'Carnes', icon: '🥩', parent: null, order: 1 },
                        { id: crypto.randomUUID(), name: 'Hortifruti', icon: '🥬', parent: null, order: 2 },
                        { id: crypto.randomUUID(), name: 'Laticínios', icon: '🥛', parent: null, order: 3 },
                        { id: crypto.randomUUID(), name: 'Limpeza', icon: '🧽', parent: null, order: 4 }
                    ],
                    items: [
                        { name: 'Arroz', quantity: 5, unit: 'kg' }, { name: 'Feijão', quantity: 2, unit: 'kg' }, { name: 'Macarrão', quantity: 4, unit: 'pct' }, { name: 'Molho de Tomate', quantity: 4, unit: 'un' }, { name: 'Óleo', quantity: 2, unit: 'un' }, { name: 'Açúcar', quantity: 2, unit: 'kg' }, { name: 'Café', quantity: 2, unit: 'pct' }, { name: 'Sal', quantity: 1, unit: 'kg' }, { name: 'Farinha de Trigo', quantity: 1, unit: 'kg' }, { name: 'Frango', quantity: 3, unit: 'kg' }, { name: 'Carne Bovina', quantity: 2, unit: 'kg' }, { name: 'Peixe', quantity: 1, unit: 'kg' }, { name: 'Ovos', quantity: 24, unit: 'un' }, { name: 'Leite', quantity: 4, unit: 'l' }, { name: 'Queijo', quantity: 500, unit: 'g' }, { name: 'Iogurte', quantity: 12, unit: 'un' }, { name: 'Pão', quantity: 2, unit: 'un' }, { name: 'Tomate', quantity: 2, unit: 'kg' }, { name: 'Cebola', quantity: 2, unit: 'kg' }, { name: 'Batata', quantity: 2, unit: 'kg' }, { name: 'Cenoura', quantity: 1, unit: 'kg' }, { name: 'Alface', quantity: 3, unit: 'un' }, { name: 'Banana', quantity: 2, unit: 'kg' }, { name: 'Maçã', quantity: 2, unit: 'kg' }, { name: 'Laranja', quantity: 2, unit: 'kg' }, { name: 'Detergente', quantity: 2, unit: 'un' }, { name: 'Sabão em Pó', quantity: 1, unit: 'cx' }, { name: 'Papel Higiênico', quantity: 1, unit: 'pct' }
                    ]
                }
            }
        ];

        let allLists = [];
        let currentTemplateData = null;
        let currentEditingListId = null;

        const loadLists = () => {
            try {
                const saved = localStorage.getItem(LISTS_KEY);
                allLists = saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error("Erro ao carregar listas:", e);
                allLists = [];
            }
        };

        const saveLists = () => {
            localStorage.setItem(LISTS_KEY, JSON.stringify(allLists));
        };

        const formatDate = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
        };

        const render = () => {
            listsContainer.innerHTML = '';
            templatesContainer.innerHTML = '';
            allLists.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (allLists.length === 0) {
                listsContainer.innerHTML = `
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 card bg-base-100/50 text-center p-8 border-2 border-dashed">
                        <div class="card-body items-center">
                            <i class="fa-solid fa-folder-open text-4xl text-base-content/30 mb-4"></i>
                            <h2 class="card-title">Nenhuma lista encontrada!</h2>
                            <p class="text-base-content/70">Crie uma nova lista ou use um modelo abaixo para começar.</p>
                        </div>
                    </div>`;
            } else {
                allLists.forEach(list => {
                    const itemCount = list.items?.length || 0;
                    const listCard = document.createElement('div');
                    listCard.className = 'card bg-base-100 shadow-lg list-card fade-in';
                    listCard.innerHTML = `
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <h2 class="card-title truncate pr-2">${list.name}</h2>
                                <div class="dropdown dropdown-end">
                                    <button tabindex="0" role="button" class="btn btn-sm btn-ghost btn-circle" aria-label="Mais opções">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-40">
                                        <li><a data-action="edit" data-id="${list.id}"><i class="fa-solid fa-pen w-4"></i>Editar nome</a></li>
                                        <li><a data-action="duplicate" data-id="${list.id}"><i class="fa-solid fa-copy w-4"></i>Duplicar</a></li>
                                        <li><hr class="my-1"></li>
                                        <li><a class="text-error" data-action="delete" data-id="${list.id}"><i class="fa-solid fa-trash w-4"></i>Excluir</a></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-sm text-base-content/60">${itemCount} item(ns)</p>
                            <span class="text-xs text-base-content/40 mt-2">Criada em: ${formatDate(list.createdAt)}</span>
                            <div class="card-actions justify-end mt-4">
                                <button class="btn btn-primary w-full" data-action="open" data-id="${list.id}">
                                    Abrir Lista <i class="fa-solid fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>`;
                    listsContainer.appendChild(listCard);
                });
            }

            templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'card card-template bg-base-100 cursor-pointer';
                templateCard.dataset.action = 'use-template';
                templateCard.dataset.id = template.id;
                templateCard.innerHTML = `
                    <div class="card-body items-center text-center p-6">
                        <div class="text-5xl mb-3">${template.icon}</div>
                        <h2 class="card-title">${template.name}</h2>
                        <p class="text-sm text-base-content/70">${template.description}</p>
                    </div>`;
                templatesContainer.appendChild(templateCard);
            });
        };

        const handleCreateList = (name) => {
            const newList = {
                id: crypto.randomUUID(), name: name.trim(), createdAt: new Date().toISOString(),
                items: [], sections: [], collapsedState: { sections: [], adder: true }
            };

            if (currentTemplateData) {
                const templateSections = currentTemplateData.sections.map(s => ({...s, id: crypto.randomUUID()}));
                const sectionMap = new Map(currentTemplateData.sections.map((s, i) => [i, templateSections[i].id]));
                newList.sections = templateSections;
                newList.items = currentTemplateData.items.map(item => ({
                    ...item, id: crypto.randomUUID(), section: sectionMap.get(0),
                    subsection: null, price: 0, inCart: false, order: 0
                }));
            }
            allLists.push(newList);
            saveLists();
            window.location.href = `lista.html?listId=${newList.id}`;
        };
        
        const handleDuplicateList = (listId) => {
            const originalList = allLists.find(l => l.id === listId);
            if (!originalList) return;

            // Cria uma cópia profunda para evitar referências ao objeto original
            const duplicatedList = JSON.parse(JSON.stringify(originalList));

            // Atualiza as propriedades da nova lista
            duplicatedList.id = crypto.randomUUID();
            duplicatedList.name = `${originalList.name} (cópia)`;
            duplicatedList.createdAt = new Date().toISOString();

            // Gera novos IDs para seções e itens para garantir independência
            const sectionIdMap = new Map();
            if (duplicatedList.sections && duplicatedList.sections.length > 0) {
                duplicatedList.sections.forEach(section => {
                    const oldId = section.id;
                    const newId = crypto.randomUUID();
                    section.id = newId;
                    sectionIdMap.set(oldId, newId);
                });
            
                // Atualiza a referência de 'parent' nas subseções, se houver
                duplicatedList.sections.forEach(section => {
                    if (section.parent && sectionIdMap.has(section.parent)) {
                        section.parent = sectionIdMap.get(section.parent);
                    }
                });
            }

            if (duplicatedList.items && duplicatedList.items.length > 0) {
                duplicatedList.items.forEach(item => {
                    item.id = crypto.randomUUID();
                    // Atualiza a referência da seção do item
                    if (item.section && sectionIdMap.has(item.section)) {
                        item.section = sectionIdMap.get(item.section);
                    }
                    // Atualiza a referência da subseção do item
                    if (item.subsection && sectionIdMap.has(item.subsection)) {
                        item.subsection = sectionIdMap.get(item.subsection);
                    }
                });
            }

            allLists.push(duplicatedList);
            saveLists();
            render();
        };

        const renderThemeSelector = () => {
            const currentTheme = localStorage.getItem('theme') || 'emerald';
            themeSelectorContainer.innerHTML = '';
            const themeGrid = document.createElement('div');
            themeGrid.className = 'grid grid-cols-2 gap-2';
            daisyuiThemes.forEach(theme => {
                const button = document.createElement('button');
                button.className = `btn btn-outline w-full ${theme === currentTheme ? 'btn-active' : ''}`;
                button.textContent = themeNames[theme];
                button.onclick = () => {
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    renderThemeSelector();
                };
                themeGrid.appendChild(button);
            });
            themeSelectorContainer.appendChild(themeGrid);
        };

        createNewListBtn.addEventListener('click', () => {
            currentEditingListId = null;
            currentTemplateData = null;
            listNameInput.value = '';
            document.getElementById('listNameModalTitle').textContent = 'Criar Nova Lista';
            listNameForm.querySelector('button[type="submit"]').textContent = 'Salvar e Abrir';
            listNameModal.showModal();
            listNameInput.focus();
        });

        listNameForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = listNameInput.value;
            
            const nameValidation = validateListName(name);
            if (!nameValidation.isValid) {
                showListNameError(nameValidation.error);
                return;
            }

            if (currentEditingListId) {
                const listToUpdate = allLists.find(l => l.id === currentEditingListId);
                if (listToUpdate) {
                    listToUpdate.name = nameValidation.sanitized;
                    saveLists();
                    render();
                }
                currentEditingListId = null;
            } else {
                handleCreateList(nameValidation.sanitized);
            }
            listNameModal.close();
        });
        
        const showListNameError = (message) => {
            const submitButton = listNameForm.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = message;
            submitButton.classList.add('btn-error');
            setTimeout(() => {
                submitButton.textContent = originalText;
                submitButton.classList.remove('btn-error');
            }, 3000);
        };

        cancelListNameBtn.addEventListener('click', () => listNameModal.close());
        
        listNameInput.addEventListener('input', (e) => {
            const validation = validateListName(e.target.value);
            e.target.setCustomValidity(validation.isValid ? '' : validation.error);
            e.target.classList.toggle('input-error', !validation.isValid);
            e.target.value = sanitizeText(e.target.value);
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const { action, id } = target.dataset;

            switch(action) {
                case 'open':
                    window.location.href = `lista.html?listId=${id}`;
                    break;
                case 'edit': {
                    const listToEdit = allLists.find(l => l.id === id);
                    if (listToEdit) {
                        currentEditingListId = id;
                        currentTemplateData = null;
                        document.getElementById('listNameModalTitle').textContent = 'Editar Nome da Lista';
                        listNameInput.value = listToEdit.name;
                        listNameForm.querySelector('button[type="submit"]').textContent = 'Salvar';
                        listNameModal.showModal();
                        listNameInput.focus();
                    }
                    break;
                }
                case 'duplicate': {
                    handleDuplicateList(id);
                    break;
                }
                case 'delete': {
                    const listToDelete = allLists.find(l => l.id === id);
                    if (listToDelete) {
                        document.getElementById('confirmDeleteMessage').innerHTML = `Você tem certeza que deseja excluir a lista "<b>${sanitizeText(listToDelete.name)}</b>"? Esta ação não pode ser desfeita.`;
                        const confirmBtn = document.getElementById('confirmDeleteConfirm');
                        
                        const newConfirmBtn = confirmBtn.cloneNode(true);
                        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                        
                        newConfirmBtn.addEventListener('click', () => {
                            allLists = allLists.filter(l => l.id !== id);
                            saveLists();
                            render();
                            confirmDeleteModal.close();
                        }, { once: true });

                        document.getElementById('confirmDeleteCancel').onclick = () => confirmDeleteModal.close();
                        confirmDeleteModal.showModal();
                    }
                    break;
                }
                case 'use-template': {
                    const template = templates.find(t => t.id === id);
                    if (template) {
                        currentEditingListId = null;
                        currentTemplateData = template.data;
                        listNameInput.value = template.name;
                        document.getElementById('listNameModalTitle').textContent = 'Usar Modelo';
                        listNameForm.querySelector('button[type="submit"]').textContent = 'Salvar e Abrir';
                        listNameModal.showModal();
                        listNameInput.focus();
                        listNameInput.select();
                    }
                    break;
                }
                case 'open-settings-modal':
                    renderThemeSelector();
                    settingsModal.showModal();
                    break;
                case 'open-backup-modal':
                    document.getElementById('backup_modal').showModal();
                    break;
            }
        });

        const exportToJson = () => {
            const data = {
                lists: allLists,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poupe-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const exportToCsv = () => {
            let csvContent = 'Lista,Seção,Item,Quantidade,Unidade,Preço,Comprado\n';
            allLists.forEach(list => {
                (list.items || []).forEach(item => {
                    const section = (list.sections || []).find(s => s.id === item.section);
                    const row = [
                        `"${list.name.replace(/"/g, '""')}"`,
                        `"${section ? section.name.replace(/"/g, '""') : 'Sem Seção'}"`,
                        `"${item.name.replace(/"/g, '""')}"`,
                        item.quantity || 1,
                        item.unit || '',
                        item.price || 0,
                        item.inCart ? 'Sim' : 'Não'
                    ].join(',');
                    csvContent += row + '\n';
                });
            });
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poupe-listas-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const importFromJson = (file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.lists && Array.isArray(data.lists)) {
                        allLists = data.lists;
                        saveLists();
                        render();
                        // Substituindo alert por um modal customizado ou toast no futuro
                        console.log('Dados importados com sucesso!');
                        document.getElementById('backup_modal').close();
                    } else {
                        console.error('Arquivo inválido.');
                    }
                } catch (error) {
                    console.error('Erro ao ler o arquivo JSON.', error);
                }
            };
            reader.readAsText(file);
        };

        document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        
        const importFileInput = document.getElementById('importFileInput');
        const importDataBtn = document.getElementById('importDataBtn');
        
        importFileInput.addEventListener('change', (e) => {
            importDataBtn.disabled = !e.target.files.length;
        });
        
        importDataBtn.addEventListener('click', () => {
            const file = importFileInput.files[0];
            // Substituindo confirm() por um modal customizado no futuro
            if (file) { // Removido confirm() para compatibilidade
                importFromJson(file);
            }
        });

        const detectSystemTheme = () => {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return 'dark';
            }
            return 'light';
        };

        const initTheme = () => {
            let currentTheme = localStorage.getItem('theme');
            
            if (!currentTheme) {
                currentTheme = detectSystemTheme();
                localStorage.setItem('theme', currentTheme);
            }
            
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme === 'light' || savedTheme === 'dark') {
                        const newTheme = e.matches ? 'dark' : 'light';
                        document.documentElement.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                        if (document.getElementById('settings_modal').open) {
                            renderThemeSelector();
                        }
                    }
                });
            }
        };

        const init = () => {
            initTheme();
            loadLists();
            render();
        };

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registrado com sucesso:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Falha ao registrar SW:', error);
                    });
            });
        }

        init();
    });
    </script>
</body>
</html>